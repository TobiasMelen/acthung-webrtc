import{h as J,T as de,p as _,F as U,_ as Z,C as h,P as Y,a as fe,B as Q}from"./index-434a33ed.js";import{u as me,S as he,D as ge,c as ve,e as ee,A as oe,j as te,s as pe,a as ye,i as Se}from"./utility-144cdd9e.js";function we(e){const[f,r]=J({}),o=me(`${he}/${e}`),m=de(S=>{r(T=>Object.keys(T).reduce((E,v)=>{var t;if(((t=T[v])==null?void 0:t[0])!==S)E[v]=T[v];else try{T[v][1].destroy()}catch(p){console.error("Error cleaning up stale connection",p)}return E},{}))},[r]);_(()=>o.status!=="connected"?void 0:o.addListener(async({from:T,data:E})=>{if(E.type!=="offer"||T==null)return;const v=new RTCPeerConnection(ge);v.onicecandidate=d=>d.candidate!=null&&o.send({to:T,data:d.candidate.toJSON()});const t=o.addListener(({from:d,data:M})=>d===T&&"candidate"in M&&v.addIceCandidate(M)),p=()=>{t==null||t(),m(v)};v.ondatachannel=({channel:d})=>{d.onclose=p,r(M=>({...M,[T]:[v,ve(v,d)]}))},v.onconnectionstatechange=()=>{v.connectionState=="disconnected"&&p()},await v.setRemoteDescription(new RTCSessionDescription(E));const x=await v.createAnswer();await v.setLocalDescription(x),o.send({data:x,to:T})}),[o]);const b=U(()=>Object.entries(f).reduce((S,[T,E])=>(S[T]=E[1],S),{}),[f]);return[o.status,b]}function X(e,f){const r=Z();_(()=>{const o=r.current;return r.current=f,e(o)},f)}const ne=(e=[])=>oe.reduce((f,r)=>(f[r]=e.indexOf(r)===-1,f),{});function be(e){const f=E=>v=>o(({[E]:t,...p})=>({...p,[E]:v(t)})),[r,o]=J({}),[m,b]=J({colorAvailability:ne(),allowSinglePlayer:!1});X(E=>{const[v]=E??[{}];o(t=>{const p=Object.keys(e),x=Object.keys(t).filter(A=>!p.includes(A)).map(A=>{var I;return clearTimeout((I=t[A])==null?void 0:I.timeout),{...t[A],timeout:window.setTimeout(()=>o(({[A]:B,...F})=>F),2e3)}}).reduce((A,I)=>(A[I.id]=I,A),{});let d,M=1;const $=p.reduce((A,I,B)=>{const F=t[I];clearTimeout(F==null?void 0:F.timeout);const N=f(I);let H=F??(()=>{var R;d=d??{...m.colorAvailability};const C=(R=Object.entries(d).find(([D,G])=>G))==null?void 0:R[0];if(C!=null)return d[C]=!1,{id:I,name:`Player ${B+1}`,color:C,ready:!1,score:0,state:"joining",latency:0,setState:D=>N(G=>({...G,state:D})),setScore:D=>N(G=>({...G,score:D})),onTurnInput:D=>{var G;return(G=e[I])==null?void 0:G.on("turn",D)}}})();if(H==null)return e[I].send("err",{reason:"lobbyFull",queuespot:M}),M++,A;const i=e[I];if(F==null||i!==v[I]){const C=(R,D,G)=>{i.on(R,L=>D(q=>({...q,[G]:L})))};C("setColor",N,"color"),C("setName",N,"name"),C("setReady",N,"ready"),C("allowSinglePlayer",b,"allowSinglePlayer"),H={...H,onTurnInput:R=>i.on("turn",R)}}return A[I]=H,A},{});return{...x,...$}})},[e]);const S=Object.values(r).map(E=>E.color);return _(()=>{b(E=>({...E,colorAvailability:ne(S)}))},[S.join(":")]),X(E=>{const[v,t]=E??[];Object.keys(r).forEach(p=>{var M,$;const x=r[p],d=t==null?void 0:t[p];e[p]!=(v==null?void 0:v[p])||d==null?(M=e[p])==null||M.send("playerState",x):x!==d&&(($=e[p])==null||$.send("playerState",ee(d,x,"function")))})},[e,r]),X(E=>{const[v,t]=E??[],p=t!==m&&ee(t,m);Object.keys(e).forEach(x=>{const d=e[x];d!=(v==null?void 0:v[x])?d==null||d.send("gameState",m):p&&(d==null||d.send("gameState",p))})},[e,m]),[U(()=>Object.values(r),[r]),m]}const Ce={canvasInfo:te,positionData:te},Ee={reportCollision:pe};function Te(){return new Worker("/acthung-webrtc/assets/collisionCanvas-53b1828d.js")}function Oe(e){return(f,r)=>ye({send:e.postMessage.bind(e),bindReceive(o){const m=b=>o(b.data);return e.addEventListener("message",m),()=>e.removeEventListener("message",m)}})(f,r)}const xe=1e3/60;function Ie(e,{snakeSpeed:f=3.3,lineWidth:r=8,turnRadius:o=.05,startPositionSpread:m=.5,startingHoleChancePercantage:b=-5,holeDuration:S=10,maxVerticalResolution:T=1080,checkCollisions:E=!0,useTrackingCollisionCanvas:v=!1}={}){const t=e.getContext("2d",{desynchronized:!0,willReadFrequently:!0})??Se("Could not get Snake canvas 2d context"),p=e.height>T?e.height/T:1;t.scale(p,p);const x=i=>({...i,hasCollided:!1,turn:0,direction:Math.round(Math.random()*360),holeChance:b,position:{x:(Math.random()+m)*(t.canvas.width*m),y:(Math.random()+m)*(t.canvas.height*m)},currentHoleSection:0,erasePos:null}),d=[],M=i=>{let C=d.find(R=>R.id===i.id);return C==null&&(C=x(i),d.push(C)),R=>{C.turn=R}};function $(i,C,R,D=!1){if(i.hasCollided)return;if(i.currentHoleSection==0&&(i.holeChance>0&&Math.random()*100<i.holeChance?(i.currentHoleSection=S,i.holeChance=b):i.holeChance=i.holeChance+.1),D&&(i.position.x<0||i.position.x>e.width||i.position.y<0||i.position.y>e.height||t.getImageData(i.position.x+(C+r/2)*Math.cos(i.direction),i.position.y+(C+r/2)*Math.sin(i.direction),1,1).data[3]!==0)&&(i.hasCollided=!0,i.onCollision()),i.erasePos!=null){t.beginPath(),t.lineCap="square",t.lineWidth=r+3;const L=t.globalCompositeOperation;t.globalCompositeOperation="destination-out",t.moveTo(i.erasePos.x,i.erasePos.y),t.lineTo(i.position.x,i.position.y),t.stroke(),t.closePath(),i.erasePos=null,t.globalCompositeOperation=L}i.currentHoleSection>0&&(i.erasePos={...i.position},i.currentHoleSection--),t.beginPath(),t.lineCap="square",t.lineWidth=r,t.strokeStyle=i.color,t.moveTo(i.position.x,i.position.y),i.direction+=i.turn*R,i.position.x+=C*Math.cos(i.direction),i.position.y+=C*Math.sin(i.direction),t.lineTo(i.position.x,i.position.y),t.stroke(),t.closePath()}const A=[];function I(i,C,R){i.send("canvasInfo",{width:e.width,height:e.height,scaleFactor:p,lineWidth:r}),A.push({interval:C,channel:i,latestReport:0}),R&&i.on("reportCollision",D=>{const G=d.find(L=>L.id===D);G&&(G.hasCollided=!0,G.onCollision())})}const B=v&&(()=>{const i=new Te;i.postMessage("SELF_HOST_CANVAS");const C=Oe(i)(Ce,Ee);return I(C,50,!0),i})();let F=!0;function N(){let i=performance.now(),C=!1;function R(D){let L=(D-i)/xe;L=L<4?L:4;const q=f*L,l=o*L;i=D;for(let s=0;s<d.length;s++)$(d[s],q,l,E&&!!(s%2)===C);C=!C;for(const s of A){let a=null;D-s.latestReport>=s.interval&&(a??(a=d.filter(u=>!u.hasCollided).map(u=>({id:u.id,fill:u.currentHoleSection?void 0:u.color,x:u.position.x,y:u.position.y}))),s.channel.send("positionData",a))}!F&&requestAnimationFrame(R)}F&&(F=!1,requestAnimationFrame(R))}function H(){F=!0}return{run:N,stop:H,inputSnakeData:M,addTrackingChannel:I,destroy(){B&&B.terminate(),H()}}}const Pe={flexGrow:1,height:"100%",width:"100%"};function Re({run:e,input:f,children:r}){const o=Z(null),[m,b]=J();return _(()=>{if(o.current==null||m)return()=>b(S=>{S==null||S.destroy()});Ae(o.current).then(S=>{b(S)})},[o.current]),_(()=>{if(m!=null)for(const S of f){const T=m.inputSnakeData(S);S.onTurnInput(T)}},[m,f]),_(()=>{m!=null&&(e?m.run():m.stop())},[m,e]),h.createElement("canvas",{ref:o,style:Pe})}async function Ae(e,{maxVerticalResolution:f=1080,...r}={}){e.style.height="100%",e.style.width="100%",e.clientHeight>f?(e.height=f,e.width=f/e.clientHeight*e.clientWidth):(e.height=e.clientHeight,e.width=e.clientWidth);const o=await("OffscreenCanvas"in window,Ie)(e,r);return{...o,destroy(){o.destroy()}}}function De(){for(var e=[[[]],[[10,7,17,13],[1,1,1,1],[]],[[16,10,28,22],[1,1,1,1],[4,16]],[[26,15,22,18],[1,1,2,2],[4,20]],[[18,20,16,26],[2,1,4,2],[4,24]],[[24,26,22,18],[2,1,4,4],[4,28]],[[16,18,28,24],[4,2,4,4],[4,32]],[[18,20,26,18],[4,2,5,6],[4,20,36]],[[22,24,26,22],[4,2,6,6],[4,22,40]],[[22,30,24,20],[5,2,8,8],[4,24,44]],[[26,18,28,24],[5,4,8,8],[4,26,48]],[[30,20,24,28],[5,4,11,8],[4,28,52]],[[22,24,28,26],[8,4,11,10],[4,30,56]],[[22,26,22,24],[9,4,16,12],[4,32,60]],[[24,30,24,20],[9,4,16,16],[4,24,44,64]],[[24,22,24,30],[10,6,18,12],[4,24,46,68]],[[28,24,30,24],[10,6,16,17],[4,24,48,72]],[[28,28,28,28],[11,6,19,16],[4,28,52,76]],[[26,30,28,28],[13,6,21,18],[4,28,54,80]],[[26,28,26,26],[14,7,25,21],[4,28,56,84]],[[26,28,28,30],[16,8,25,20],[4,32,60,88]],[[26,28,30,28],[17,8,25,23],[4,26,48,70,92]],[[28,28,24,30],[17,9,34,23],[4,24,48,72,96]],[[28,30,30,30],[18,9,30,25],[4,28,52,76,100]],[[28,30,30,30],[20,10,32,27],[4,26,52,78,104]],[[28,26,30,30],[21,12,35,29],[4,30,56,82,108]],[[28,28,30,28],[23,12,37,34],[4,28,56,84,112]],[[28,30,30,30],[25,12,40,34],[4,32,60,88,116]],[[28,30,30,30],[26,13,42,35],[4,24,48,72,96,120]],[[28,30,30,30],[28,14,45,38],[4,28,52,76,100,124]],[[28,30,30,30],[29,15,48,40],[4,24,50,76,102,128]],[[28,30,30,30],[31,16,51,43],[4,28,54,80,106,132]],[[28,30,30,30],[33,17,54,45],[4,32,58,84,110,136]],[[28,30,30,30],[35,18,57,48],[4,28,56,84,112,140]],[[28,30,30,30],[37,19,60,51],[4,32,60,88,116,144]],[[28,30,30,30],[38,19,63,53],[4,28,52,76,100,124,148]],[[28,30,30,30],[40,20,66,56],[4,22,48,74,100,126,152]],[[28,30,30,30],[43,21,70,59],[4,26,52,78,104,130,156]],[[28,30,30,30],[45,22,74,62],[4,30,56,82,108,134,160]],[[28,30,30,30],[47,24,77,65],[4,24,52,80,108,136,164]],[[28,30,30,30],[49,25,81,68],[4,28,56,84,112,140,168]]],f=0,r=4,o=[],m=[-1],b=0,S=1;b<255;++b)o.push(S),m[S]=b,S=S*2^(S>=128?285:0);for(var T=[[]],b=0;b<30;++b){for(var E=T[b],v=[],t=0;t<=b;++t){var p=t<b?o[E[t]]:0,x=o[(b+(E[t-1]||0))%255];v.push(m[p^x])}T.push(v)}for(var b=0;b<45;++b);var d=function(l){return l>6},M=function(l){return 4*l+17},$=function(l){var s=e[l],a=16*l*l+128*l+64;return d(l)&&(a-=36),s[2].length&&(a-=25*s[2].length*s[2].length-10*s[2].length-55),a},A=function(l){var s=$(l)&-8,a=e[l];return s-=8*a[0][1]*a[1][1],s},I=l=>l<10?8:16,B=function(l){var s=A(l)-4-I(l);return s/8|0},F=function(l,s,a,u){var c=[],n=0,y=8,g=a.length,O=function(w,z){if(z>=y){for(c.push(n|w>>(z-=y));z>=8;)c.push(w>>(z-=8)&255);n=0,y=8}z>0&&(n|=(w&(1<<z)-1)<<(y-=z))},P=I(l);O(s,4),O(g,P);for(var W=0;W<g;++W)O(a[W],8);for(O(f,4),y<8&&c.push(n);c.length+1<u;)c.push(236,17);return c.length<u&&c.push(236),c},N=function(l,s){for(var a=l.slice(0),u=l.length,c=s.length,n=0;n<c;++n)a.push(0);for(var y=0;y<u;){var g=m[a[y++]];if(g>=0)for(var O=0;O<c;++O)a[y+O]^=o[(g+s[O])%255]}return a.slice(u)},H=function(l,s,a){for(var u=[],c=l.length/s|0,n=0,y=s-l.length%s,g=0;g<y;++g)u.push(n),n+=c;for(var g=y;g<s;++g)u.push(n),n+=c+1;u.push(n);for(var O=[],g=0;g<s;++g)O.push(N(l.slice(u[g],u[g+1]),a));for(var P=[],W=l.length/s|0,g=0;g<W;++g)for(var w=0;w<s;++w)P.push(l[u[w]+g]);for(var w=y;w<s;++w)P.push(l[u[w+1]-1]);for(var g=0;g<a.length;++g)for(var w=0;w<s;++w)P.push(O[w][g]);return P},i=function(l,s,a,u){for(var c=l<<u,n=s-1;n>=0;--n)c>>u+n&1&&(c^=a<<n);return l<<u|c},C=function(l){for(var s=e[l],a=M(l),u=[],c=[],n=0;n<a;++n)u.push([]),c.push([]);var y=function(K,k,se,ce,ue){for(var V=0;V<se;++V)for(var j=0;j<ce;++j)u[K+V][k+j]=ue[V]>>j&1,c[K+V][k+j]=1};y(0,0,9,9,[127,65,93,93,93,65,383,0,64]),y(a-8,0,8,9,[256,127,65,93,93,93,65,127]),y(0,a-8,9,8,[254,130,186,186,186,130,254,0,0]);for(var n=9;n<a-8;++n)u[6][n]=u[n][6]=~n&1,c[6][n]=c[n][6]=1;for(var g=s[2],O=g.length,n=0;n<O;++n)for(var P=n===0||n===O-1?1:0,W=n===0?O-1:O,w=P;w<W;++w)y(g[n],g[w],5,5,[31,17,21,17,31]);if(d(l))for(var z=i(l,6,7973,12),le=0,n=0;n<6;++n)for(var w=0;w<3;++w)u[n][a-11+w]=u[a-11+w][n]=z>>le++&1,c[n][a-11+w]=c[a-11+w][n]=1;return{matrix:u,reserved:c}},R=function(l,s,a){for(var u=l.length,c=0,n=-1,y=u-1;y>=0;y-=2){y===6&&--y;for(var g=n<0?u-1:0,O=0;O<u;++O){for(var P=y;P>y-2;--P)s[g][P]||(l[g][P]=a[c>>3]>>(~c&7)&1,++c);g+=n}n=-n}return l},D=function(l,s){for(var a=(y,g)=>(y+g)%2===0,u=l.length,c=0;c<u;++c)for(var n=0;n<u;++n)s[c][n]||(l[c][n]^=a(c,n));return l},G=function(l,s){for(var a=l.length,u=i(s<<3|0,5,1335,10)^21522,c=0;c<15;++c){var n=[0,1,2,3,4,5,7,8,a-7,a-6,a-5,a-4,a-3,a-2,a-1][c],y=[a-1,a-2,a-3,a-4,a-5,a-6,a-7,a-8,7,5,4,3,2,1,0][c];l[n][8]=l[8][y]=u>>c&1}return l},L=function(l,s){var a=e[s],u=F(s,r,l,A(s)>>3);u=H(u,a[1][1],T[a[0][1]]);var c=C(s),n=c.matrix,y=c.reserved;return R(n,y,u),D(n,y),G(n,1),n},q={generate:function(l){const s=new TextEncoder().encode(l);let a=1;for(a=1;a<=40&&!(s.length<=B(a));++a);return L(s,a)},writeToCanvas:function(l,s,{fillColor:a="#FFFFFF",textColor:u="#000000",margin:c=1.5,modSize:n=10}={}){var y=q.generate(l),g=y.length,O=n*(g+2*c);s.width=s.height=O;const P=s.getContext("2d");if(P==null)throw new Error("Could not get context from canvas");P.fillStyle=a,P.fillRect(0,0,O,O),P.fillStyle=u,P.imageSmoothingEnabled=!1;for(var W=0;W<g;++W)for(var w=0;w<g;++w)y[W][w]&&P.fillRect(n*(c+w),n*(c+W),n,n)}};return q}function ie({children:e,style:f}){const r=Z(null);return _(()=>{r.current&&e&&De().writeToCanvas(e,r.current)},[r.current,e]),h.createElement("canvas",{style:f,ref:r})}const Ge={display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"start"};function Me({url:e,players:f}){return h.createElement(Y,{style:{justifyContent:"space-around"}},h.createElement("div",null),h.createElement("div",{style:{width:"40%"}},h.createElement(ie,{colorScheme:"onWhiteBg",padding:2,style:{width:"100%",margin:"0 auto 2em auto"}},e),h.createElement("a",{href:e,style:{textAlign:"center",display:"block",fontSize:"0.8em",marginTop:"0.8em",alignSelf:"center"}},e)),h.createElement("div",{style:{...Ge,width:0,flexGrow:f.length?.5:0,transition:"flex-grow 500ms ease-in"}},f.map(r=>h.createElement(Fe,{key:r.id,...r}))))}const Fe=e=>{const[f,r]=J(!1);return _(()=>{window.setTimeout(()=>r(!0),100)},[]),h.createElement("div",{style:{opacity:f?1:0,margin:"1.2em 0",transition:"transform 150ms ease-in, opacity 150ms ease-in",transform:e.ready?"scale(1.1) translateX(5%)":void 0,animation:"fadeIn 250ms ease-in, fromRight 500ms ease-in",minWidth:"7em"},key:e.id},h.createElement("h2",{style:{color:e.color,fontSize:"3em",transition:"color 150ms",whiteSpace:"nowrap"}},e.name," ",e.ready?h.createElement("small",null,"👍"):"  "))};function Le(e,f){const r=U(()=>localStorage!=null&&localStorage[e]?JSON.parse(localStorage[e]):f,[]),[o,m]=J(r);return _(()=>{localStorage&&(localStorage[e]=JSON.stringify(o))},[o]),[o,m]}const ae={snakeSpeed:3.3,lineWidth:8,turnRadius:.05,startPositionSpread:.5,startingHoleChancePercantage:-5,holeDuration:10,maxVerticalResolution:1080},We=fe([ae,()=>{}]);function _e({children:e}){const f=Le("gameSettings",ae);return h.createElement(We.Provider,{value:f},e)}function Ne({players:e,url:f}){return h.createElement("div",{style:{position:"absolute",zIndex:-1,right:0,display:"flex",flexDirection:"column",justifyContent:"center",height:"100%"}},h.createElement("div",{style:{flexGrow:1,display:"flex",justifyContent:"center",flexDirection:"column",alignItems:"flex-end"}},e.map(r=>h.createElement("div",{key:r.id,style:{color:r.color,textAlign:"right",margin:"0 1.5em",paddingBottom:"2em"}},h.createElement("div",{style:{fontSize:"5.2em"}},r.score),h.createElement("div",{style:{fontSize:"1.2em",whiteSpace:"nowrap"}},r.name)))),oe.length>e.length&&h.createElement(ie,{colorScheme:"onWhiteBg",padding:2,style:{width:150,height:150,margin:"2em"}},f))}const re=(e,f)=>({type:"intermission",remainingTime:5,roundWinner:e,gameWinner:f});function Be({lobbyName:e}){const[f,r]=we(e),[o,m]=be(r);return f==="connecting"?h.createElement(Q,{style:{animation:"fadeIn 300ms 750ms both"}},"Signaling server is ",h.createElement("span",{style:{color:"yellow"}},"warming")," up."," ",h.createElement("br",null),h.createElement("small",{style:{fontSize:"0.5em"}},"This while take a while ",h.createElement("br",null)," (free tier hosting)")):f==="failed"?h.createElement(Q,null,"Signaling server connection ",h.createElement("span",{style:{color:"red"}},"failed")," "):h.createElement(_e,null,h.createElement(He,{lobbyName:e,players:o,allowSinglePlayer:m.allowSinglePlayer}))}function He({lobbyName:e,allowSinglePlayer:f=!1,players:r}){const[o,m]=J({type:"lobby"}),b=U(()=>(r.length||1)*5,[r.length]);_(()=>{if(o.type==="intermission")if(o.remainingTime){const t=setTimeout(()=>(m({...o,remainingTime:o.remainingTime-1}),()=>clearTimeout(t)),1e3)}else m({type:"playing",running:!0,joinedPlayerIds:r.filter(t=>t.ready).map(t=>(t.setState("playing"),t.id))})},[o]),_(()=>{o.type==="lobby"&&r.length&&(r.length>1||f)&&r.every(t=>t.ready)&&m(re()),o.type!=="lobby"&&!r.some(t=>t.ready)&&m({type:"lobby"})},[r,o.type]);const S=U(()=>{if(o.type!=="playing")return null;const t=r.filter(p=>o.joinedPlayerIds.includes(p.id));return{joined:t,alive:t.filter(p=>p.state==="playing")}},[o.type,r]);_(()=>{if(!S)return;const t=S.alive.length,p=t===1&&S.joined.length===1;if(t<=1&&!p){m(d=>({...d,running:!1}));const x=S.joined.reduce((d,M)=>M.score>((d==null?void 0:d.score)??0)?M:d,null);window.setTimeout(()=>{m(d=>d.type==="playing"?re(S.alive[0]??{color:"inherit",name:"Nobody"},((x==null?void 0:x.score)??0)>b?x:void 0):d)},1e3)}},[S]);const T=t=>{S!=null&&(t.setState("dead"),S.alive.filter(p=>p.id!==t.id).forEach(p=>p.setScore(p.score+1)))},E=U(()=>o.type==="playing"?r.filter(t=>o.joinedPlayerIds.includes(t.id)).map(t=>({id:t.id,color:t.color,onCollision:()=>T(t),onTurnInput:t.onTurnInput})):[],[o.type,r]),v=`${window.location.protocol}//${window.location.host}${window.location.pathname}#${e}`;switch(o.type){case"lobby":return h.createElement(Me,{players:r,url:v});case"playing":return h.createElement(Y,null,h.createElement(Re,{input:E,run:o.running}),h.createElement(Ne,{players:r,url:v}));case"intermission":{const t=o.gameWinner!=null?h.createElement(Q,null,h.createElement("span",{style:{color:o.gameWinner.color}},o.gameWinner.name)," ","wins the game!"):o.remainingTime<=3?h.createElement(Q,{key:"countdown"},o.roundWinner?"Next round":"Game starts"," in"," ",h.createElement("span",{style:{width:"1em",display:"inline-block"}},o.remainingTime)):o.roundWinner?h.createElement(Q,null,h.createElement("span",{style:{color:o.roundWinner.color}},o.roundWinner.name)," ","survives"):h.createElement(Q,null,"Get ready");return h.createElement(Y,{key:o.remainingTime>3?"message":"countdown"},t)}}}export{He as Game,Be as default};
//# sourceMappingURL=Lobby-8877f575.js.map
